{
  "Resources" : {
    "PrivateTable" : {
      "Properties" : {
        "VpcId" : {
          "Ref" : "Devops"
        }
      },
      "Type" : "AWS::EC2::RouteTable"
    },
    "DefaultGateway" : {
      "Properties" : { },
      "Type" : "AWS::EC2::InternetGateway"
    },
    "Nat" : {
      "Properties" : {
        "VpcId" : {
          "Ref" : "Devops"
        },
        "GroupDescription" : "NAT ",
        "SecurityGroupIngress" : [ {
          "ToPort" : "-1",
          "CidrIp" : "0.0.0.0/0",
          "IpProtocol" : "icmp",
          "FromPort" : "-1"
        }, {
          "IpProtocol" : "tcp",
          "FromPort" : "22",
          "ToPort" : "22",
          "CidrIp" : "0.0.0.0/0"
        }, {
          "ToPort" : "80",
          "CidrIp" : "0.0.0.0/0",
          "IpProtocol" : "tcp",
          "FromPort" : "80"
        }, {
          "ToPort" : "443",
          "CidrIp" : "0.0.0.0/0",
          "IpProtocol" : "tcp",
          "FromPort" : "443"
        } ]
      },
      "Type" : "AWS::EC2::SecurityGroup"
    },
    "PublicSubnet" : {
      "Properties" : {
        "VpcId" : {
          "Ref" : "Devops"
        },
        "CidrBlock" : "10.0.0.0/24"
      },
      "Type" : "AWS::EC2::Subnet"
    },
    "InstanceMountPoint" : {
      "Properties" : {
        "InstanceId" : {
          "Ref" : "WebNode"
        },
        "VolumeId" : {
          "Ref" : "DefaultVolume"
        },
        "Device" : "/dev/xvdf"
      },
      "Type" : "AWS::EC2::VolumeAttachment"
    },
    "NatNode" : {
      "Properties" : {
        "KeyName" : "devops_prd",
        "InstanceType" : "t2.micro",
        "SubnetId" : {
          "Ref" : "PublicSubnet"
        },
        "PrivateIpAddress" : "10.0.0.40",
        "SourceDestCheck" : "false",
        "SecurityGroupIds" : [ {
          "Ref" : "Nat"
        } ],
        "ImageId" : null
      },
      "Type" : "AWS::EC2::Instance"
    },
    "DefaultConnection" : {
      "Properties" : {
        "VpcId" : {
          "Ref" : "Devops"
        },
        "InternetGatewayId" : {
          "Ref" : "DefaultGateway"
        }
      },
      "Type" : "AWS::EC2::VPCGatewayAttachment"
    },
    "NatIpAddress" : {
      "Properties" : {
        "InstanceId" : {
          "Ref" : "NatNode"
        },
        "Domain" : "vpc"
      },
      "Type" : "AWS::EC2::EIP",
      "DependsOn" : "DefaultConnection"
    },
    "PrivateRoute" : {
      "Properties" : {
        "DestinationCidrBlock" : "0.0.0.0/0",
        "InstanceId" : {
          "Ref" : "NatNode"
        },
        "RouteTableId" : {
          "Ref" : "PrivateTable"
        }
      },
      "Type" : "AWS::EC2::Route"
    },
    "PublicSubnetRoute" : {
      "Properties" : {
        "SubnetId" : {
          "Ref" : "PublicSubnet"
        },
        "RouteTableId" : {
          "Ref" : "PublicTable"
        }
      },
      "Type" : "AWS::EC2::SubnetRouteTableAssociation"
    },
    "PublicRoute" : {
      "Properties" : {
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : {
          "Ref" : "DefaultGateway"
        },
        "RouteTableId" : {
          "Ref" : "PublicTable"
        }
      },
      "Type" : "AWS::EC2::Route",
      "DependsOn" : "DefaultConnection"
    },
    "DefaultVolume" : {
      "Type" : "AWS::EC2::Volume",
      "Properties" : {
        "Size" : null,
        "AvailabilityZone" : {
          "Fn::GetAtt" : [ "WebNode", "AvailabilityZone" ]
        }
      }
    },
    "Web" : {
      "Properties" : {
        "VpcId" : {
          "Ref" : "Devops"
        },
        "GroupDescription" : "Enable  SSH access from anywhere",
        "SecurityGroupIngress" : [ {
          "IpProtocol" : "tcp",
          "FromPort" : "22",
          "ToPort" : "22",
          "CidrIp" : "0.0.0.0/0"
        }, {
          "ToPort" : "80",
          "CidrIp" : "0.0.0.0/0",
          "IpProtocol" : "tcp",
          "FromPort" : "80"
        }, {
          "ToPort" : "443",
          "CidrIp" : "0.0.0.0/0",
          "IpProtocol" : "tcp",
          "FromPort" : "443"
        } ]
      },
      "Type" : "AWS::EC2::SecurityGroup"
    },
    "PrivateSubnet" : {
      "Properties" : {
        "VpcId" : {
          "Ref" : "Devops"
        },
        "CidrBlock" : "10.0.1.0/24"
      },
      "Type" : "AWS::EC2::Subnet"
    },
    "Devops" : {
      "Properties" : {
        "CidrBlock" : "10.0.0.0/16"
      },
      "Type" : "AWS::EC2::VPC"
    },
    "PrivateSubnetRoute" : {
      "Properties" : {
        "SubnetId" : {
          "Ref" : "PrivateSubnet"
        },
        "RouteTableId" : {
          "Ref" : "PrivateTable"
        }
      },
      "Type" : "AWS::EC2::SubnetRouteTableAssociation"
    },
    "PublicTable" : {
      "Properties" : {
        "VpcId" : {
          "Ref" : "Devops"
        }
      },
      "Type" : "AWS::EC2::RouteTable"
    },
    "Database" : {
      "Properties" : {
        "VpcId" : {
          "Ref" : "Devops"
        },
        "SecurityGroupIngress" : [ {
          "ToPort" : "3306",
          "CidrIp" : "0.0.0.0/0",
          "IpProtocol" : "tcp",
          "FromPort" : "3306"
        } ],
        "GroupDescription" : "Pass all traffic"
      },
      "Type" : "AWS::EC2::SecurityGroup"
    },
    "WebNode" : {
      "Properties" : {
        "KeyName" : "devops_prd",
        "InstanceType" : "c3.large",
        "SubnetId" : {
          "Ref" : "PrivateSubnet"
        },
        "PrivateIpAddress" : "10.0.1.30",
        "SourceDestCheck" : "false",
        "ImageId" : "ami-116d857a",
        "SecurityGroupIds" : [ {
          "Ref" : "Web"
        } ]
      },
      "Type" : "AWS::EC2::Instance"
    }
  },
  "AWSTemplateFormatVersion" : "2010-09-09"
}